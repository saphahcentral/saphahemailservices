name: Saphahemailservices Automation

on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *"   # Hourly – JS decides what actually runs

permissions:
  contents: write

jobs:
  email-job:
    runs-on: ubuntu-latest

    steps:
      # -------------------------------------------------------------
      # STEP 1 – CHECKOUT REPOSITORY
      # -------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -------------------------------------------------------------
      # STEP 2 – SETUP NODE.JS
      # -------------------------------------------------------------
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      # -------------------------------------------------------------
      # STEP 3 – INSTALL DEPENDENCIES
      # -------------------------------------------------------------
      - name: Install dependencies
        run: npm ci || npm install

      # -------------------------------------------------------------
      # STEP 4 – WEEKEND PAUSE CHECK
      # -------------------------------------------------------------
      - name: Check for weekend pause
        run: |
          mkdir -p LOGS
          LOGFILE="LOGS/email_status.log"

          DAY=$(date -u +%u)
          HOUR=$(date -u +%H)
          NOW=$(date -u '+%Y-%m-%d %H:%M:%S UTC')

          echo "UTC Day: $DAY | Hour: $HOUR"

          # Pause from Friday 15:00 UTC → Monday 06:00 UTC
          if { [ "$DAY" -eq 5 ] && [ "$HOUR" -ge 15 ]; } || \
             [ "$DAY" -eq 6 ] || \
             { [ "$DAY" -eq 7 ] && [ "$HOUR" -lt 6 ]; }; then
            echo "$NOW — CLOSED FOR WEEKEND — email sending paused." | tee -a "$LOGFILE"
            exit 0
          fi

          echo "$NOW — Normal run window — continuing." | tee -a "$LOGFILE"

      # -------------------------------------------------------------
      # STEP 5 – ENSURE REQUIRED DIRECTORIES
      # -------------------------------------------------------------
      - name: Ensure directories exist
        run: mkdir -p LOGS SENT SCHEDULE

      # -------------------------------------------------------------
      # STEP 6 – RUN EMAIL SERVICE (GUARDED BY data.json)
      # -------------------------------------------------------------
      - name: Run Gmail email service
        env:
          GMAIL_USER: ${{ secrets.GMAIL_USER }}
          GMAIL_CLIENT_ID: ${{ secrets.GMAIL_CLIENT_ID }}
          GMAIL_CLIENT_SECRET: ${{ secrets.GMAIL_CLIENT_SECRET }}
          GMAIL_REFRESH_TOKEN: ${{ secrets.GMAIL_REFRESH_TOKEN }}
          EMAILFIREBASEADMIN: ${{ secrets.EMAILFIREBASEADMIN }}
        run: node email-send.js

      # -------------------------------------------------------------
      # STEP 7 – COMMIT LOGS / SENT / data.json
      # -------------------------------------------------------------
      - name: Commit state updates
        run: |
          git config user.name "GitHub Action"
          git config user.email "actions@github.com"

          git add SENT LOGS data.json || true
          git commit -m "Update email logs and run state" || echo "No changes"
          git push || true
